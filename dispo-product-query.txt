
(define dispo-product-query
  (string-append 
   "SELECT DISTINCT "
   "pd.produit_descript_num, "
   "pd.produit_status, "
   "UCASE(pd.produit_refcom) as refcom, "
   "(SELECT valeur FROM comprendre WHERE produit_descript_num = pd.produit_descript_num AND propriete_num = 77) as EAN, "
   "pd.produit_descript_designation, "
   "pd.produit_type, "
   "mt.par_ht, "
   "mt.pvp_ht, "
   "mt3.pvp_ht as pvp_ht3, "
   "mt4.pvp_ht as pvp_ht3_priv, "
   "mt5.pvp_ht as pvp_ht3_vip, "
   "mt2.pvc_ttc as pvc_ttc2, "
   "at.qte_phys as phys, "
   "IFNULL( ((at.qte_phys + at5.qte_phys) - (at.qte_resvd + at2.qte_resvd + at3.qte_resvd + at5.qte_resvd + at7.qte_resvd)), 0) as qte_dispo_total, "
   "IFNULL((at.qte_resvd + at2.qte_resvd + at3.qte_resvd + at5.qte_resvd + at7.qte_resvd), 0) as qte_resvd_total, "
   "(SELECT count(*) FROM produit p, mw_stock s WHERE p.produit_descript_num = pd.produit_descript_num AND p.produit_etat = 0 AND p.etat_nom = 'OK' AND s.produit_num = p.produit_num AND s.stock_qte = 1) AS AV "
   "FROM produit_descript pd "
   "LEFT JOIN mw_tarifs mt ON (mt.id_pd = pd.produit_descript_num AND mt.id_lan = '1' AND mt.ty_tar = (SELECT ty_tar FROM mw_types WHERE produit_type = pd.produit_type) AND mt.flpromo = '0' AND mt.id_famc = '0' AND (mt.par_ht + mt.pvp_ht + mt.pvc_ttc + mt.pvc_ht) > 0) "
   "LEFT JOIN mw_tarifs mt2 ON (mt2.id_pd = pd.produit_descript_num AND mt2.id_lan = '2' AND mt2.ty_tar = (SELECT ty_tar FROM mw_types WHERE produit_type = pd.produit_type) AND mt2.flpromo = '0' AND mt2.id_famc = '0' AND (mt2.pvp_ht + mt2.pvc_ttc) > 0) "
   "LEFT JOIN mw_tarifs mt3 ON (mt3.id_pd = pd.produit_descript_num AND mt3.id_lan = '3' AND mt3.ty_tar = (SELECT ty_tar FROM mw_types WHERE produit_type = pd.produit_type) AND mt3.flpromo = '0' AND mt3.id_famc = '0' AND mt3.pvp_ht > 0) "
   "LEFT JOIN mw_tarifs mt4 ON (mt4.id_pd = pd.produit_descript_num AND mt4.id_lan = '3' AND mt4.ty_tar = (SELECT ty_tar FROM mw_types WHERE produit_type = pd.produit_type) AND mt4.flpromo = '0' AND mt4.id_famc = '1' AND mt4.pvp_ht > 0) "
   "LEFT JOIN mw_tarifs mt5 ON (mt5.id_pd = pd.produit_descript_num AND mt5.id_lan = '3' AND mt5.ty_tar = (SELECT ty_tar FROM mw_types WHERE produit_type = pd.produit_type) AND mt5.flpromo = '0' AND mt5.id_famc = '2' AND mt5.pvp_ht > 0) "
   "LEFT JOIN mw_attributions at ON (at.produit_descript_num = pd.produit_descript_num AND at.lanp =  '1' AND at.produit_type = pd.produit_type) "
   "LEFT JOIN mw_attributions at2 ON (at2.produit_descript_num = pd.produit_descript_num AND at2.lanp = '2' AND at2.produit_type = pd.produit_type) "
   "LEFT JOIN mw_attributions at3 ON (at3.produit_descript_num = pd.produit_descript_num AND at3.lanp = '3' AND at3.produit_type = pd.produit_type) "
   "LEFT JOIN mw_attributions at5 ON (at5.produit_descript_num = pd.produit_descript_num AND at5.lanp = '5' AND at5.produit_type = pd.produit_type) "
   "LEFT JOIN mw_attributions at7 ON (at7.produit_descript_num = pd.produit_descript_num AND at7.lanp = '7' AND at7.produit_type = pd.produit_type) "
   "WHERE pd.magasin_num = 0 "
   "AND (pd.produit_type = 'R' OR pd.produit_refcom LIKE 'R%') "
   "AND pd.categorie_num = '28' "
   "AND pd.produit_status = 1 "
   "AND ((at.qte_phys + at5.qte_phys) - (at.qte_resvd + at2.qte_resvd + at3.qte_resvd + at5.qte_resvd + at7.qte_resvd)) > 0 "
   "AND pd.produit_descript_designation NOT LIKE '%EXPORT' "
   "AND pd.produit_descript_archivee = 0 "
   "ORDER BY qte_dispo_total DESC")
